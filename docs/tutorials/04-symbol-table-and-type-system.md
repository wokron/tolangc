# 符号表与类型系统

## 符号表

在介绍中间代码之前，我们先学习符号表的生成和管理。符号表是编译过程中的一个重要结构，主要用于记录各个符号的标识以及相应的信息，包括作用域、类型、大小、维度、存储地址等，在编译过程中遇到对应符号时即可快速查询到相应信息。

### 符号表的生成

在编译过程中，遇到变量声明定义的语句时，我们就可以把对应的信息填入符号表。对于一张符号表来说，通常具有如图的结构：一个指向外层作用域符号表的指针pre，表主体（符号名与对应信息），若干指向内层作用域符号表的指针next。此外，在编译的过程中，有一个指向当前作用域符号表的指针cur。

<img src="../../figure/symbol_table.png" alt="parser_3" style="zoom:40%;" />

符号表的生成主要有以下几个操作：

1. 初始时，创建一个全局变量符号表，也是最外层作用域符号表，cur指向该符号表。
2. 编译时，遇到变量声明语句，解析出需要的信息（一般包括类型、维度、大小等），填入cur指向的符号表。
3. 编译时，进入新的作用域（block），生成新的符号表，设置cur指向的符号表的next指针指向新符号表，新符号表的pre设置为cur，然后将cur指向新符号表，后续会在新符号表上填入信息。
4. 编译时，离开作用域（block），通过cur指向的符号表的pre指针回溯至外层符号表，并对应修改cur指针。

不难发现，这样生成的符号表，具有树结构。当然，也可以按栈式结构来组织，即进入新的作用域，就压入新的符号表，离开作用域时，弹出当前符号表，但是这种方法不能保存下使用过的符号表的信息。

### 符号表的查询

在编译的过程中，如果遇到一个变量的引用，就需要确定该变量是否定义过，以及其相关信息，此时我们需要查询符号表。

对于一个变量名，符号表的查询主要有以下几个操作：

1. 在当前作用域符号表查询，是否有该变量名的记录，有则返回信息，无则继续操作2.
2. 利用当前作用域符号表的pre指针，访问外层作用域符号表。如果当前作用域符号表为最外层符号表（pre指针为空），说明该变量名在各个符号表中都没有定义，此时报变量未定义错误；否则，进入外层作用域符号表，进行操作1.

实际上，符号表的查询就是一个向上的递归查询，直至最外层符号表。

需要注意的是，符号表中存储的信息需要尽可能详细，以方便后续的查找使用，比如对于数组的信息，可以考虑将每个维度的大小都记录下来，同时由于数组维度一定是常数表达式，可以考虑在这里直接计算出维数大小，方便后续访问数组元素时获取维度信息；对于函数名，可以记录函数所需参数个数，各个参数类型，返回值类型等；对于变量，包括数组变量，可以记录其在当前block内的偏移地址。
